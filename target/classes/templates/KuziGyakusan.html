<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">  
<head>
    <meta charset="UTF-8">
    
    <title>一番くじ期待値計算</title> 
    
    <link rel="stylesheet" href="/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" th:inline="javascript"></script>
    <style>
      /* メインコンテナのスタイル */
      main {
        width: 100%;
        display: flex;
        justify-content: center;
      }
      /* グラフを表示するためのスタイル */
      #js-result {
        display: flex;
        flex-wrap: wrap;
        width: 50%;
        gap: 20px;
        justify-content: center;
      }
      /* キャンバス（グラフ）自体のスタイル */
      canvas {
        flex: 1 0 48%;
        max-width: 100%;
        height: 50vh;
        margin-bottom: 20px;
      }
    </style>
</head>
<body>
    <h1>購入枚数ごとの期待値</h1>
    <p>
        <a href="https://1kuji.com/products" target="_blank" rel="noopener noreferrer">
            一番くじのラインナップを見る（公式サイト）
        </a><br><br>
        <a href="/kuzi"> 購入枚数から期待値を計算したい方はこちら</a>
    </p>
    
    <img src="/images/slot.gif" alt="アニメーション" />
    
    <form action="/KuziGyakusan" method="post">
        残りくじ総数: <input name="total" type="number" th:value="${total}"><br>
        当たり枚数: <input name="atari" type="number" th:value="${atari}"><br>
        小数点以下の計算桁数: <input name="Digits" type="number" th:value="${Digits}"><br>
        <button type="submit">計算する</button>
    </form>
    
    <div th:if="${error}" style="color: red; margin-bottom: 10px;">
        <p th:text="${error}"></p>
    </div>

    <div th:if="${KeyProbs != null}">
        <h2>主要な期待値</h2>
        <table class="center-table" border="1">
            <thead>
            <tr>
            <th>購入数</th>
            <th>あたりが一つ以上出る確率</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="entry : ${KeyProbs}">
                    <td th:text="${entry.key + '枚'}">n</td>
                    <td th:attr="data-raw=${entry.value}" th:text="${#numbers.formatDecimal(entry.value, 1, Digits) + '%'}">確率</td>
            </tr>
            </tbody>
        </table>
        <main>
        <!-- グラフを表示するコンテナ -->
        <div id="js-result"></div>
        </main>
        <script th:inline="javascript">
        // グラフを描画するためのキャンバス要素を生成する関数
        const result = document.getElementById("js-result");
        const createCanvas = () => {
        const canvas = document.createElement("canvas");
        canvas.width = 400;
        canvas.height = 200;
        result.appendChild(canvas);
        return canvas;
        };
        const chartData = /*[[ ${Probs.values()} ]]*/ [];
        const chartLabels = /*[[ ${Probs.keySet()} ]]*/ []; 
        console.log("chartData:", chartData);
        console.log("chartLabels:", chartLabels);   
        const lineChart = new Chart(createCanvas(), {
            type: "line",
            data: {
            labels: chartLabels, // X軸のラベル
                datasets: [{
                label: "あたりが一つ以上出る確率", // データセットのラベル
                data: chartData, // Y軸のデータ
                borderColor: "rgb(75, 192, 192)", // 線の色
                tension: 0.1, // 線のカーブの緩やかさ
                }],
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        labels: {
                            // 凡例のテキストの色を黒（#000000）に設定
                            color: '#000000' ,
                            font: {
                                size: 20 
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: 'あたりが一つ以上出る確率 (%)',
                            color: '#000000',
                            font: {
                                size: 20 
                            }
                        },
                        beginAtZero: true,
                        // Y軸の最大値をデータの最大値に合わせて「100」に設定します
                        max: 100, 
                        // 目盛り（グリッド線）の間隔を10に設定すると見やすくなります
                        ticks: {
                            stepSize: 10 
                        },
                       
                    },
                    x: {
                        title: {
                            display: true,
                            text: '購入枚数',
                            color: '#000000',
                            font: {
                                size: 20 
                            }
                        },
                    },
                },
            },
        });
        </script>
        <details>
        <summary style="cursor: pointer; font-weight: bold; padding: 5px;">
            各購入数における詳細な確率を表示
        </summary>
        <p>
            <table class="center-table" border="1">
                <thead>
                <tr>
                <th>購入数</th>
                <th>あたりが一つ以上出る確率</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="entry : ${Probs}">
                    <td th:text="${entry.key + '枚'}">n</td>
                    <td th:attr="data-raw=${entry.value}" th:text="${#numbers.formatDecimal(entry.value, 1, Digits) + '%'}">確率</td>
                </tr>
                </tbody>
            </table>
        </p>
        </details>
    </div>
</body>
</html>